{"version":3,"sources":["assets/script/network/SocketDelegate.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import GameDataCenter from \"../userData/GameDataCenter\";\nimport EventMng from \"../framework/manager/EventMng\";\nimport UIHelp from \"../framework/ui/UIHelp\";\nimport { Websocket } from \"./Websocket\";\nimport { ConfigModule } from \"../userData/ConfigModule\";\nimport GameController from \"../GameController\";\nimport { Log, LOG_TAG } from \"../utils/Log\";\n\nexport class SocketDelegate {\n    private url: string;\n    private websocket: Websocket;\n\n    constructor() {\n        if(ConfigModule.IS_TEST){\n            this.url = ConfigModule.WS_URL_TEST;        \n        }else{\n            this.url = ConfigModule.WS_URL_DEV;        \n        }\n    }\n   \n    public connect() {\n        this.websocket = new Websocket({\n            url: this.url,\n            pingTimeout: 3000,\n            pongTimeout: 5000,\n            pingMsg: JSON.stringify({\"c\":\"game\",\"m\":\"ping\",\"data\":{}})\n        });\n\n        this.websocket.onopen = this.onopen.bind(this);\n        this.websocket.onmessage = this.onmessage.bind(this);\n        this.websocket.onreconnect = this.onreconnect.bind(this);\n        this.websocket.onclose = this.onclose.bind(this);\n        this.websocket.onerror = this.onerror.bind(this);\n    }\n\n    public send(c: string, m: string, data: any) {\n        var obj: Object = {\n            \"c\": c,\n            \"m\": m,\n            \"data\": data\n        };\n\n        this.websocket.send(JSON.stringify(obj))\n\n        if (cc.sys.isNative) {\n            Log.logTag(LOG_TAG.SOCKET, '%cSOCKET发送-->','color:#fff;background:red', JSON.stringify(obj))\n        } else {\n            Log.logTag(LOG_TAG.SOCKET, '%cSOCKET发送-->','color:#fff;background:red', obj);\n        }\n    }\n\n    public close(){\n        this.websocket.close();\n    }\n\n    //需要自己补充逻辑\n    public toLoginScene(){\n        GameController.socket.close();\n        // if (cc.director.getScene().name == \"hallScene\") {\n        //     cc.director.loadScene(\"loginScene\");\n        // }\n    }\n\n    private onopen(){\n        Log.warn('connect success');\n        // cc.director.resume();\n        UIHelp.CloseLoding();\n        GameDataCenter.socketModel.login();\n    }\n\n    private appandeMsg(data) {\n        var self = this;\n\n        if (data.m != \"ping\" && data.m != \"pong\") {\n            if (cc.sys.isNative) {\n                Log.logTag(LOG_TAG.SOCKET, '%cSOCKET接收-->','color:#fff;background:green',JSON.stringify(data))\n            } else {\n                Log.logTag(LOG_TAG.SOCKET, '%cSOCKET接收-->','color:#fff;background:green',data)\n            }\n        }\n\n        data['src'] = 'tcp';\n\n        if (data.m == \"pong\") {\n            self.websocket.heartCheck();\n        } else {\n            if (data.data.errcode) {\n                UIHelp.ShowTips(data['data'][\"errmsg\"]);\n\n                if(data.m == \"login\"){\n                    Log.error(\"login失败，返回首页，清空jwt\")\n                    self.toLoginScene();\n                    return\n                }\n\n                if (data.data.errcode == 503) {\n                    //服务器维护中\n                    self.toLoginScene();\n                }\n                   \n                return\n            }\n\n            EventMng.emit(`${data.c}_${data.m}`, data.data);\n        }\n    }\n\n    private onmessage(e){\n        var self = this;\n        if (cc.sys.isNative) {\n            var a = new Uint8Array(e.data)\n            let packet: Object = JSON.parse(self.Utf8ArrayToStr(a))\n            self.appandeMsg(packet);\n        } else {\n            if(cc.sys.platform == cc.sys.WECHAT_GAME){\n                var str = self.arrayBufferToString(e)\n                let packet: Object = JSON.parse(str);\n                self.appandeMsg(packet);\n            }else{\n                var fileReader = new FileReader();\n                fileReader.onload = function (progressEvent) {\n                    var arrayBuffer: ArrayBuffer = this.result as ArrayBuffer;//arrayBuffer即为blob对应的arrayBuffer  \n                    var a = new Uint8Array(arrayBuffer)\n                    let packet: Object = JSON.parse(self.Utf8ArrayToStr(a))\n                    self.appandeMsg(packet);\n                };\n                fileReader.readAsArrayBuffer(e.data);\n            }\n        }\n    }\n\n    private onreconnect(){\n        Log.error('reconnecting...');\n        // cc.director.pause();\n        UIHelp.ShowLoding();\n    }\n\n    private onclose(){\n    }\n\n    private onerror(){\n    }\n\n    private Utf8ArrayToStr(array) {\n        var out, i, len, c;\n        var char2, char3;\n\n        out = \"\";\n        len = array.length;\n        i = 0;\n        while (i < len) {\n            c = array[i++];\n            switch (c >> 4) {\n                case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7:\n                    // 0xxxxxxx\n                    out += String.fromCharCode(c);\n                    break;\n                case 12: case 13:\n                    // 110x xxxx   10xx xxxx\n                    char2 = array[i++];\n                    out += String.fromCharCode(((c & 0x1F) << 6) | (char2 & 0x3F));\n                    break;\n                case 14:\n                    // 1110 xxxx  10xx xxxx  10xx xxxx\n                    char2 = array[i++];\n                    char3 = array[i++];\n                    out += String.fromCharCode(((c & 0x0F) << 12) |\n                        ((char2 & 0x3F) << 6) |\n                        ((char3 & 0x3F) << 0));\n                    break;\n            }\n        }\n\n        return out;\n    }\n\n    private arrayBufferToString(arr) {\n        if (typeof arr === 'string') {\n            return arr;\n        }\n        var dataview = new DataView(arr.data);\n        var ints = new Uint8Array(arr.data.byteLength);\n        for (var i = 0; i < ints.length; i++) {\n            ints[i] = dataview.getUint8(i);\n        }\n        arr = ints;\n        var str = '',\n            _arr = arr;\n        for (var i = 0; i < _arr.length; i++) {\n            var one = _arr[i].toString(2),\n                v = one.match(/^1+?(?=0)/);\n            if (v && one.length == 8) {\n                var bytesLength = v[0].length;\n                var store = _arr[i].toString(2).slice(7 - bytesLength);\n                for (var st = 1; st < bytesLength; st++) {\n                    store += _arr[st + i].toString(2).slice(2);\n                }\n                str += String.fromCharCode(parseInt(store, 2));\n                i += bytesLength - 1;\n            } else {\n                str += String.fromCharCode(_arr[i]);\n            }\n        }\n        return str;\n    }\n}"]}