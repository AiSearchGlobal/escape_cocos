{"version":3,"sources":["assets/script/framework/adapter/manager/PageViewManager.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["// import { _decorator, EventTouch } from 'cc';\nimport { Manager } from '../abstract/Manager';\nimport { AlwaysScroll } from '../define/enum';\nimport { ScrollManager } from './ScrollManager';\nimport { ViewManager } from './ViewManager';\nconst { ccclass, property } = cc._decorator;\nenum Event {\n    /** 分页的长度变更时 */\n    ON_PAGE_LENGTH_CHANGED,\n    /** 滚动分页开始时 */\n    ON_SCROLL_PAGE_BEFOR,\n    /** 滚动分页结束时 */\n    ON_SCROLL_PAGE_END,\n}\n@ccclass('PageViewManager')\nexport class PageViewManager extends Manager<Event> {\n    public static Event = Event\n    @property() private _enabled: boolean = false\n    @property() get enabled() { return this._enabled }\n    set enabled(value: boolean) {\n        if (value == this._enabled) return\n        this._enabled = value\n        if (this._enabled) {\n            this._register()\n        } else {\n            this._unregister()\n        }\n    }\n    @property({\n        range: [0, 1],\n        slide: true,\n        step: 0.01,\n        visible: function () { return this.enabled },\n        tooltip: \"滚动临界值，默认单位百分比，当拖拽超出该数值时，松开会自动滚动下一页，小于时则还原\"\n    }) scrollThreshold: number = 0.5\n\n    @property({\n        range: [0, 1],\n        slide: true,\n        step: 0.01,\n        visible: function () { return this.enabled },\n        tooltip: \"设置 PageView PageTurning 事件的发送时机\"\n    }) pageTurningEventTiming: number = 0.1\n\n    @property({\n        visible: function () { return this.enabled },\n        tooltip: `快速滑动翻页临界值\n        当用户快速滑动时，会根据滑动开始和结束的距离与时间计算出一个速度值\n        该值与此临界值相比较，如果大于临界值，则进行自动翻页`\n    }) autoPageTurningThreshold: number = 100\n\n    @property({\n        visible: function () { return this.enabled },\n        tooltip: \"每个页面翻页时所需时间。单位：秒\"\n    }) pageTurningSpeed: number = 0.3\n    private _currentIndex: number = 0\n    get currentIndex() { return this._currentIndex }\n    get length() { return this.adapter.viewManager.groupLength }\n    protected onInit(): void {\n        this._register()\n    }\n    private _register() {\n        if (!this.adapter || !this.enabled) return\n        this.adapter.scrollManager.on(ScrollManager.Event.ON_SCROLL_END, this._handleReleaseLogic, this)\n        this.adapter.scrollManager.on(ScrollManager.Event.ON_SCROLL_CANCEL, this._handleReleaseLogic, this)\n        this.adapter.scrollManager.on(ScrollManager.Event.ON_SCROLL_TO_GROUPINDEX_BEFOR, this._onScrollToIndex, this)\n        this.adapter.viewManager.on(ViewManager.Event.ON_UPDATE_VIEWS, this._onUpdateViews, this, true)\n    }\n    private _unregister() {\n        if (!this.adapter || this.enabled) return\n        this.adapter.scrollManager.off(ScrollManager.Event.ON_SCROLL_END, this._handleReleaseLogic, this)\n        this.adapter.scrollManager.off(ScrollManager.Event.ON_SCROLL_CANCEL, this._handleReleaseLogic, this)\n        this.adapter.scrollManager.off(ScrollManager.Event.ON_SCROLL_TO_GROUPINDEX_BEFOR, this._onScrollToIndex, this)\n        this.adapter.viewManager.off(ViewManager.Event.ON_UPDATE_VIEWS, this._onUpdateViews, this)\n    }\n    public scrollToPage(duration: number, index: number, alwaysScroll?: AlwaysScroll) {\n        if (index < 0 || index >= this.length) {\n            return\n        }\n        if (index == this.currentIndex && this.adapter.scrollManager.calcOffset() != 0) {\n            return\n        }\n        this.adapter.scrollManager.scrollToGroupIndex(duration, index, alwaysScroll)\n        this.emit(Event.ON_SCROLL_PAGE_BEFOR, index)\n    }\n    /**\n     * 滚动到上一页\n     * @param duration 持续时间\n     * @param alwaysScrollToHeader 强制向头部滚动\n     */\n    public scrollToPrevPage(duration: number = this.pageTurningSpeed, alwaysScroll: AlwaysScroll = AlwaysScroll.Header) {\n        if (this._currentIndex == 0) {\n            if (this.adapter.viewManager.loopHeader) {\n                this.scrollToPage(duration, this.length - 1, alwaysScroll)\n            }\n            return\n        }\n        this.scrollToPage(duration, this._currentIndex - 1, alwaysScroll)\n    }\n    /**\n     * 滚动到下一页\n     * @param duration 持续时间\n     * @param alwaysScrollToFooter 强制向尾部滚动\n     */\n    public scrollToNextPage(duration: number = this.pageTurningSpeed, alwaysScroll: AlwaysScroll = AlwaysScroll.Footer) {\n        if (this._currentIndex >= this.length - 1) {\n            if (this.adapter.viewManager.loopFooter) {\n                this.scrollToPage(duration, 0, alwaysScroll)\n            }\n            return\n        }\n        this.scrollToPage(duration, this._currentIndex + 1, alwaysScroll)\n    }\n    private _onUpdateViews() {\n        this.emit(Event.ON_PAGE_LENGTH_CHANGED)\n        this._currentIndex = 0\n        this.scrollToPage(this.pageTurningSpeed, this._currentIndex)\n    }\n    private _onScrollToIndex(index: number) {\n        this._currentIndex = index\n        this.emit(Event.ON_SCROLL_PAGE_END, index)\n    }\n    private _handleReleaseLogic(event: cc.Event.EventTouch) {\n        if (!this._enabled || !this.adapter.scrollManager.isMyEventAndMoved) return\n        var start = event.getStartLocation()[this.adapter.mainAxis]\n        var end = event.getLocation()[this.adapter.mainAxis]\n        var offset = start - end\n        var nextIndex = this._getNextIndex(offset)\n        if (this._isScrollable(offset) || this._isQuicklyScrollable(this.adapter.scrollManager.velocity)) {\n            this.scrollToPage(this.pageTurningSpeed, nextIndex)\n            return\n        }\n        this.scrollToPage(this.pageTurningSpeed, this._currentIndex)\n    }\n\n    private _getNextIndex(offset: number) {\n        var index = this._currentIndex\n        if (this.adapter.isHorizontal) {\n            if (this.adapter.isArrangeAxisStart) {\n                if (offset > 0) {\n                    index++\n                } else if (offset < 0) {\n                    index--\n                }\n            } else {\n                if (offset < 0) {\n                    index++\n                } if (offset > 0) {\n                    index--\n                }\n            }\n\n        } else {\n            if (this.adapter.isArrangeAxisStart) {\n                if (offset < 0) {\n                    index++\n                } else if (offset > 0) {\n                    index--\n                }\n            } else {\n                if (offset > 0) {\n                    index++\n                } else if (offset < 0) {\n                    index--\n                }\n            }\n        }\n        if (index >= this.length && this.adapter.viewManager.loopFooter) {\n            index = 0\n        } else if (index < 0 && this.adapter.viewManager.loopHeader) {\n            index = this.length - 1\n        }\n\n        if (index < 0 || index >= this.length) {\n            index = this._currentIndex\n        }\n        return index\n    }\n    private _isScrollable(offset: number) {\n        return Math.abs(offset) >= this.adapter.mainAxisSize * this.scrollThreshold\n    }\n    private _isQuicklyScrollable(touchMoveVelocity: number) {\n        return Math.abs(touchMoveVelocity) > this.autoPageTurningThreshold\n    }\n}\n\n"]}