{"version":3,"sources":["assets/script/userData/SocketModel.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import EventMng from \"../framework/manager/EventMng\";\nimport IDataModel from \"../framework/model/IDataModel\";\nimport UIHelp from \"../framework/ui/UIHelp\";\nimport UIGameLayer from \"../logic/ui/prefab/UIGameLayer\";\nimport UIKiller from \"../logic/ui/prefab/UIKiller\";\nimport UIGame from \"../logic/ui/scene/UIGame\";\nimport { Log } from \"../utils/Log\";\nimport { GameEvent } from \"./EventConst\";\nimport GameDataCenter from \"./GameDataCenter\";\nimport PlayerModel from \"./PlayerModel\";\n\nexport default class SocketModel extends IDataModel {\n    constructor() {\n        super('SocketModel');\n    }\n\n    /**需要重写 */\n    getMessageListeners() {\n        return {\n            // key为消息名，value为触发函数\n            ['game_login']: (msg) => { this.socket_login(msg) },\n            ['game_move']: (msg) => { this.socket_move(msg) },\n            ['game_roominfo']: (msg) => { this.socket_roominfo(msg) },\n            ['game_stage']: (msg) => { this.socket_stage(msg) },\n            ['game_betting']: (msg) => { this.socket_betting(msg) },\n            ['game_leave']: (msg) => { this.socket_leave(msg) },\n            ['game_join']: (msg) => { this.socket_join(msg) },\n            ['game_userlist']: (msg) => { this.socket_userlist(msg) },\n            ['game_bettinglist']: (msg) => { this.socket_bettinglist(msg) },\n            ['game_sync_status']: (msg) => { this.socket_sync_status(msg) },\n            ['game_close']: (msg) => { this.socket_close(msg) },\n\n        }\n    }\n\n    //登录\n    login(){\n        this.sendSocketMsg(\"game\", \"login\", {jwt: GameDataCenter.accountModel.jwt})\n    }\n\n    /** 加入房间 */\n    joinRoom(room_type: number){\n        this.sendSocketMsg(\"game\", \"joinroom\", {room_type: room_type});\n    }\n\n    /**\n     * 移动到某一房间\n     * @param roomId\n     */\n    move(roomId: number){\n        this.sendSocketMsg(\"game\", \"move\", {roomid: roomId})\n    }\n\n    /**\n     * 下注\n     * @param roomId 房间id\n     * @param id 下注id\n     */\n    betting(roomId: number, id: number){\n        this.sendSocketMsg(\"game\", \"betting\", {roomid: roomId, id: id})\n    }\n\n    socket_login(msg){\n        Log.warn(\"长链接登录成功\");\n        var accountModel = GameDataCenter.accountModel;\n        var data = msg.data.user;\n        accountModel.avatar = data.avatar;\n        accountModel.nickName = data.nickname;\n        accountModel.uid = data.id;\n        accountModel.status = data.status;\n        this.joinRoom(1);\n    }\n\n    //进入游戏会执行一次\n    socket_roominfo(msg){\n        GameDataCenter.accountModel.players.forEach(player => {\n            player.destroy();\n        });\n        \n        var data = msg.data;\n        GameDataCenter.roomInfoModel.roomId = data.betting_roomid;\n        GameDataCenter.roomInfoModel.initData(data.roominfo);\n        GameDataCenter.roomInfoModel.initRoomsCoin(data.rooms, false);\n        GameDataCenter.roomInfoModel.initBettingConf(data.betting_config);\n        GameDataCenter.roomInfoModel.setCoin(msg.data.user);\n        EventMng.emit(GameEvent.SET_DOORS, data.roominfo.game_stage);\n        UIGameLayer.instance.showLastKillerAni();\n    }\n\n    socket_move(msg){\n        var data = msg.data;\n        GameDataCenter.roomInfoModel.initRoomsCoin(data.rooms, true);\n\n        if(data.betting.uid != GameDataCenter.accountModel.uid){\n            GameDataCenter.accountModel.players.get(data.betting.uid).moveToRoomById(data.betting.roomid);\n        }\n    }\n\n    socket_stage(msg){\n        var data = msg.data;\n\n        var game_stage: number = data.game_stage;\n\n        GameDataCenter.roomInfoModel.changeRoomStage(data);\n        UIGameLayer.instance.showLastKillerAni();\n\n        switch (game_stage) {\n            case 1:\n                EventMng.emit(GameEvent.OPEN_GAME);\n                GameDataCenter.roomInfoModel.roomId = data.betting_roomid;\n                GameDataCenter.roomInfoModel.initData(data.roominfo);\n                GameDataCenter.roomInfoModel.initRoomsCoin(data.rooms, false);\n                GameDataCenter.roomInfoModel.initBettingConf(data.betting_config);\n                break;\n            case 3:\n                UIGame.instance.showStage3Ani();\n                UIGameLayer.instance.showStage3Ani();\n                break;\n            case 4:\n                UIKiller.instance.kill(data.shaid);\n                break;\n            case 5:\n                GameDataCenter.roomInfoModel.setKillResult(data);\n                GameDataCenter.roomInfoModel.setCoin(data.user);\n                UIGame.instance.showStage5Ani();\n                break;\n            default:\n                break;\n        }\n    }\n\n    socket_betting(msg){\n        var data = msg.data;\n        var betting = data.betting;\n        var player = GameDataCenter.accountModel.players.get(betting.uid);\n\n        if(betting.uid != GameDataCenter.accountModel.uid){\n            player.moveToRoomById(betting.roomid);\n        }else{\n            player.showBetting(betting.coin);\n        }\n\n        GameDataCenter.roomInfoModel.minPlayerNum = data.betting_num;\n        GameDataCenter.roomInfoModel.maxPlayerNum = data.total_num;\n\n        GameDataCenter.roomInfoModel.initRoomsCoin(data.rooms, true);\n        GameDataCenter.roomInfoModel.setCoin(msg.data.user);\n    }\n\n    socket_leave(msg){\n        var data = msg.data;\n        var player = GameDataCenter.accountModel.players.get(data.uid);\n        player?.destroy();\n    }\n\n    socket_join(msg){\n        var data = msg.data;\n        if(data.is_betting){\n            return\n        }\n\n        this.createPlayer(data.user, 0);\n    }\n\n    //没选择房间的玩家\n    socket_userlist(msg){\n        var data = msg.data;\n        var userlist = data.userlist;\n\n        for(let index of userlist){\n            this.createPlayer(index, 0);\n        }\n    }\n\n    //选择房间的玩家\n    socket_bettinglist(msg){\n        var data = msg.data;\n        var bettinglist = data.bettinglist;\n\n        for(let i in bettinglist){\n            let index = bettinglist[i];\n            this.createPlayer(index, index.roomid);\n            if(index.uid == GameDataCenter.accountModel.uid){\n                GameDataCenter.roomInfoModel.roomId = index.roomid;\n                var player = GameDataCenter.accountModel.players.get(index.uid);\n                player.showBetting(index.coin);//\n            }\n        }\n    }\n\n    socket_sync_status(msg){\n        var data = msg.data;\n        GameDataCenter.roomChoseModel.initData(data.room_status);\n    }\n\n    socket_close(msg){\n        EventMng.emit(GameEvent.CLOSE_GAME);\n    }\n\n    private createPlayer(user: any, roomId: number){\n        if(GameDataCenter.accountModel.players.get(user.uid)){\n            return\n        }\n\n        let player = new PlayerModel();\n        player.initData(user);\n        if(GameDataCenter.accountModel.players.size <= 60){\n            player.loadPlayerAni(roomId);\n        }\n        GameDataCenter.accountModel.players.set(user.uid, player);\n    }\n}"]}