{"version":3,"sources":["assets/script/framework/component/VMParent.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { Log } from '../../utils/Log';\nimport { VM } from './ViewModel';\nimport VMBase from \"./VMBase\";\n\n\nconst { ccclass, property,help,executionOrder} = cc._decorator;\n\n\n/**\n * 提供VM环境，控制旗下所有VM节点\n * 一般用于 非全局的 VM绑定,VM 环境与 组件紧密相连\n * （Prefab 模式绑定）\n * VMParent 必须必其他组件优先执行\n * v0.1 修复bug ，现在可以支持 Parent 嵌套 （但是注意性能问题，不要频繁嵌套）\n */\n@ccclass\n@executionOrder(-1)\n@help('https://github.com/wsssheep/cocos_creator_mvvm_tools/blob/master/docs/VMParent.md')\nexport default class VMParent extends cc.Component {\n\n    /**绑定的标签，可以通过这个tag 获取 当前的 vm 实例 */\n    protected tag: string = '_temp';\n\n    /**需要绑定的私有数据 */\n    protected data: any = {};\n\n    /**VM 管理 */\n    public VM = VM;\n \n\n    /**\n     * [注意]不能直接覆盖此方法，如果需要覆盖。\n     * 只能在该方法内部调用父类的实现 \n    ```ts\n        onLoad(){\n            super.onLoad();\n        }\n    ``` \n     * \n     */\n    protected onLoad() {\n        if (this.data == null) return;\n        this.tag = '_temp' + '<'+ this.node.uuid.replace('.', '') + '>';\n        VM.add(this.data, this.tag);\n        //cc.log(VM['_mvs'],tag)\n        //搜寻所有节点：找到 watch path\n        let comps = this.getVMComponents();\n        for (let i = 0; i < comps.length; i++) {\n            const comp = comps[i];\n            this.replaceVMPath(comp,this.tag)\n        }\n\n        this.onBind();\n    }\n\n    /**在 onLoad 完成 和 start() 之前调用，你可以在这里进行初始化数据等操作 */\n    protected onBind() {\n\n    }\n\n    /**在 onDestroy() 后调用,此时仍然可以获取绑定的 data 数据*/\n    protected onUnBind() {\n\n    }\n\n    private replaceVMPath(comp:cc.Component,tag:string){\n        let path: string = comp['watchPath'];\n        //let comp_name: string = comp.name;\n\n        if (comp['templateMode'] == true) {\n             let pathArr:string[] = comp['watchPathArr'];\n             if(pathArr){\n                for (let i = 0; i < pathArr.length; i++) {\n                    const path = pathArr[i];\n                    pathArr[i] =  path.replace('*', tag);\n                }\n             }\n\n        } else {\n            //VMLabel\n\n            //遇到特殊 path 就优先替换路径\n            if (path.split('.')[0] === '*') {\n                comp['watchPath'] = path.replace('*', tag);\n            }\n\n        }\n        // Log.log(comp['watchPath'])\n    }\n\n    /**未优化的遍历节点，获取VM 组件 */\n    private getVMComponents(){\n        let comps = this.node.getComponentsInChildren('VMBase');\n        let parents = this.node.getComponentsInChildren('VMParent').filter(v => v.uuid !== this.uuid); //过滤掉自己\n\n        //过滤掉不能赋值的parent\n        let filters = [];\n        parents.forEach((node:cc.Node)=>{\n            filters = filters.concat(node.getComponentsInChildren('VMBase'));\n        })\n\n        comps = comps.filter((v)=>filters.indexOf(v)<0);\n        return comps;\n    }\n\n\n\n\n    /**\n     * [注意]不能覆盖此方法，如果需要覆盖。\n     * 需要在该方法内部调用父类的实现，再定义自己的方法\n      ```ts\n        onDestroy(){\n            super.onDestroy();\n        }\n      ```\n     */\n    protected onDestroy() {\n        this.onUnBind();\n        //解除全部引用\n        VM.remove(this.tag);\n        this.data = null;\n    }\n\n    // update (dt) {}\n}\n"]}