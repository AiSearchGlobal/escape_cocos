{"version":3,"sources":["assets/script/framework/sdk/H5WxSdkTool.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { Log } from \"../../utils/Log\";\nimport { FrameEventConst } from \"../const/FrameEventConst\";\nimport { base64 } from \"../lib/base64\";\nimport { Cryptos } from \"../lib/crypto\";\nimport EventMng from \"../manager/EventMng\";\nimport IDataModel from \"../model/IDataModel\";\ndeclare let WeixinJSBridge: any  // 解决 WeixinJSBridge 在TS编译会报错\n\nexport default class H5WxSdkTool extends IDataModel {\n    private static instance: H5WxSdkTool;\n\n    private payData: any;\n    private payCallback: Function;\n    private env = {\n        uploadImageUrl: \"xxxx\",         // 你的阿里云OSS地址  在你当前小程序的公众号后台的uploadFile 合法域名也要配上这个域名\n        AccessKeySecret: 'xxxx',        // AccessKeySecret 去你的阿里云上控制台上找\n        OSSAccessKeyId: 'xxxx',         // AccessKeyId 去你的阿里云上控制台上找\n        timeout: 80000                  //这个是上传文件时Policy的失效时间\n    }\n    \n    constructor() {\n        super();\n    }\n\n    //获取这个单例\n    static getInstance() {\n        if (!this.instance) {\n            this.instance = new H5WxSdkTool();\n        }\n        return this.instance;\n    }\n\n    getSign() {\n        let url = location.href.split('#')[0];\n        var params = {\n            url: encodeURIComponent(url)\n        }\n\n        this.sendHttpMsg(\"login/getwxconfig\", params, this.setConfig, false);\n    }\n\n    private setConfig(res){\n        const wxConfig = res.data;\n\n        wx[\"config\"]({\n            debug: false,\n            appId: wxConfig.appid,\n            timestamp: wxConfig.timestamp,\n            nonceStr: wxConfig.noncestr,\n            signature: wxConfig.signature,\n            jsApiList: [\n                'updateAppMessageShareData',  // 分享给朋友\n                'updateTimelineShareData',  // 朋友圈\n            ]\n        });\n\n        wx[\"error\"](() => {\n            Log.log(`wx.error`)\n        })\n\n        wx[\"ready\"](() => {   //需在用户可能点击分享按钮前就先调用\n            Log.log(`wx.ready`)\n            this.shareMessage();\n            this.shareTimeline();\n        });\n    }\n\n    //自定义“分享给朋友”及“分享到QQ”按钮的分享内容\n    public shareMessage() {\n        wx[\"ready\"](function () {   //需在用户可能点击分享按钮前就先调用\n            wx[\"updateAppMessageShareData\"]({\n                title: '', // 分享标题\n                desc: '', // 分享描述\n                link: '', // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致\n                imgUrl: '', // 分享图标\n                success: function () {\n                }\n            })\n        });\n    }\n\n    //自定义“分享到朋友圈”及“分享到QQ空间”按钮的分享内容\n    public shareTimeline() {\n        wx[\"ready\"](function () {\n            wx[\"updateTimelineShareData\"]({\n                title: '', // 分享标题\n                link: '', // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致\n                imgUrl: '', // 分享图标\n                success: function () {\n\n                }\n            })\n        });\n    }\n\n    //获取“分享到腾讯微博”按钮点击状态及自定义分享内容接口\n    public shareWeibo(){\n        wx[\"onMenuShareWeibo\"]({\n            title: '', // 分享标题\n            desc: '', // 分享描述\n            link: '', // 分享链接\n            imgUrl: '', // 分享图标\n            success: function () {\n            // 用户确认分享后执行的回调函数\n            },\n            cancel: function () {\n            // 用户取消分享后执行的回调函数\n            }\n        });\n    }\n\n    //预览图片功能,下载分享\n    public previewImage(url: string){\n        wx.previewImage({\n            current: url, // 当前显示图片的http链接\n            urls: [url] // 需要预览的图片http链接列表\n        })\n    }\n\n    public pay(data: any, payCallback: Function) {\n        this.payData = data;\n        this.payCallback = payCallback;\n        \n\t\tif (typeof WeixinJSBridge == \"undefined\") {\n\t\t\tif (document.addEventListener) {\n\t\t\t\tdocument.addEventListener('WeixinJSBridgeReady', () => {\n\t\t\t\t\tthis.onBridgeReady();\n\t\t\t\t}, false);\n\t\t\t} else if (document[\"attachEvent\"]) {\n\t\t\t\tdocument[\"attachEvent\"]('WeixinJSBridgeReady', () => {\n\t\t\t\t\tthis.onBridgeReady();\n\t\t\t\t});\n\t\t\t\tdocument[\"attachEvent\"]('onWeixinJSBridgeReady', () => {\n\t\t\t\t\tthis.onBridgeReady();\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tthis.onBridgeReady();\n\t\t}\n    }\n\n    /** 拉起JSAPI支付接口 */\n\tprivate onBridgeReady() {\n\t\tWeixinJSBridge.invoke(\n\t\t\t'getBrandWCPayRequest',\n\t\t\t{\n\t\t\t\t\"appId\": this.payData.appId,\n\t\t\t\t\"timeStamp\": this.payData.timeStamp,\n\t\t\t\t\"nonceStr\": this.payData.nonceStr,\n\t\t\t\t\"package\": this.payData.package,\n\t\t\t\t\"signType\": this.payData.signType,\n\t\t\t\t\"paySign\": this.payData.paySign\n\t\t\t},\n\t\t\t(res) =>{\n\t\t\t\tif (res.err_msg == \"get_brand_wcpay_request:ok\") {\n                    Log.log(\"充值成功\")\n                    this.payCallback();\n\t\t\t\t} else if (res.err_msg == \"get_brand_wcpay_request:cancel\") {\n\t\t\t\t} else if (res.err_msg == \"get_brand_wcpay_request:fail\") {\n                    Log.log(\"充值失败\", res)\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\t}\n\n    //----------------选择照片上传阿里云OSS----------------\n    public chooseImage(){\n        var self = this;\n        wx.chooseImage({\n            count: 1, // 默认最多一次选择9张图\n            sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有\n            sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有\n            success: function (res) {\n               // 返回选定照片的本地文件路径列表，tempFilePath可以作为img标签的src属性显示图片\n               var tempFilePaths = res.tempFilePaths;\n               Log.log(\"tempFilePaths\", tempFilePaths);\n               var nowTime = self.formatTime(new Date());\n    \n               //支持多图上传\n               for (var i = 0; i < res.tempFilePaths.length; i++) {\n                  //显示消息提示框\n                  wx.showLoading({\n                     title: '上传中' + (i + 1) + '/' + res.tempFilePaths.length,\n                     mask: true\n                  })\n    \n                  //上传图片\n                  //你的域名下的/images文件下的/当前年月日文件下的/图片.png\n                  //图片路径可自行修改\n                  self.uploadFile(res.tempFilePaths[i], 'images/' + nowTime + '/',\n                     function (result) {\n                        Log.log(\"======上传成功图片地址为：\", result);\n                        //做你具体的业务逻辑操作\n                        EventMng.emit(FrameEventConst.WX_UPLOAD_IMG_SUCCESS, result);\n                        wx.hideLoading();\n                     }, function (result) {\n                        Log.log(\"======上传失败======\", result);\n                        //做你具体的业务逻辑操作\n    \n                        wx.hideLoading()\n                     }\n                  )\n               }\n            }\n        })\n    }\n\n    private uploadFile(filePath, dir, successc, failc) {\n        if (!filePath || filePath.length < 1) {\n           wx.showModal({\n              title: '图片错误',\n              content: '请重试',\n              showCancel: false,\n           })\n           return;\n        }\n      \n        Log.log('上传图片.....');\n        //图片名字 可以自行定义，     这里是采用当前的时间戳 + 150内的随机数来给图片命名的\n        const aliyunFileKey = dir + new Date().getTime() + Math.floor(Math.random() * 150) + '.png';\n      \n        const aliyunServerURL = this.env.uploadImageUrl;//OSS地址，需要https\n        const accessid = this.env.OSSAccessKeyId;\n        const policyBase64 = this.getPolicyBase64();\n        const signature = this.getSignature(policyBase64);//获取签名\n      \n        wx.uploadFile({\n           url: aliyunServerURL,//开发者服务器 url\n           filePath: filePath,//要上传文件资源的路径\n           name: 'file',//必须填file\n           formData: {\n              'key': aliyunFileKey,\n              'policy': policyBase64,\n              'OSSAccessKeyId': accessid,\n              'signature': signature,\n              'success_action_status': '200',\n           },\n           success: function (res) {\n              if (res.statusCode != 200) {\n                 failc(new Error('上传错误:' + JSON.stringify(res)))\n                 return;\n              }\n              successc(aliyunServerURL + aliyunFileKey);\n           },\n           fail: function (err) {\n              err.wxaddinfo = aliyunServerURL;\n              failc(err);\n           },\n        })\n    }\n\n    private getPolicyBase64() {\n        let date = new Date();\n        date.setHours(date.getHours() + this.env.timeout);\n        let srcT = date.toISOString();\n        const policyText = {\n           \"expiration\": srcT, //设置该Policy的失效时间，超过这个失效时间之后，就没有办法通过这个policy上传文件了 \n           \"conditions\": [\n              [\"content-length-range\", 0, 5 * 1024 * 1024] // 设置上传文件的大小限制,5mb\n           ]\n        };\n      \n        const policyBase64 = base64.encode(JSON.stringify(policyText));\n        return policyBase64;\n    }\n      \n    private getSignature(policyBase64) {\n        const accesskey = this.env.AccessKeySecret;\n        const bytes = Cryptos.HMAC(policyBase64, accesskey, {\n           asBytes: true\n        });\n        const signature = Cryptos.util.bytesToBase64(bytes);\n\n        return signature;\n    }\n\n    private formatTime(date){\n        const year = date.getFullYear()\n        const month = date.getMonth() + 1\n        const day = date.getDate()\n        const hour = date.getHours()\n        const minute = date.getMinutes()\n        const second = date.getSeconds()\n      \n        return [year, month, day].map(this.formatNumber).join('-')\n         // + ' ' + [hour, minute, second].map(formatNumber).join(':')\n    }\n\n    private formatNumber(n) {\n        n = n.toString()\n        return n[1] ? n : '0' + n\n    }\n    //----------------选择照片上传阿里云OSS----------------\n}"]}