{"version":3,"sources":["assets/script/framework/sdk/XcxSdk.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import GameDataCenter from \"../../userData/GameDataCenter\";\nimport { Log } from \"../../utils/Log\";\nimport { FrameEventConst } from \"../const/FrameEventConst\";\nimport { base64 } from \"../lib/base64\";\nimport { Cryptos } from \"../lib/crypto\";\nimport { AudioMng } from \"../manager/AudioMng\";\nimport EventMng from \"../manager/EventMng\";\nimport IDataModel from \"../model/IDataModel\";\n\nexport default class XcxSdk extends IDataModel {\n    public wxRun: number = 0;\n    public shareStartTime: number;\n\n    private env = {\n        uploadImageUrl: \"xxxx\",         // 你的阿里云OSS地址  在你当前小程序的公众号后台的uploadFile 合法域名也要配上这个域名\n        AccessKeySecret: 'xxxx',        // AccessKeySecret 去你的阿里云上控制台上找\n        OSSAccessKeyId: 'xxxx',         // AccessKeyId 去你的阿里云上控制台上找\n        timeout: 80000                  //这个是上传文件时Policy的失效时间\n    }\n\n    constructor() {\n        super();\n\n        //注册右上角...里的分享，分享朋友圈\n        wx.showShareMenu({\n            withShareTicket: true,\n            menus: ['shareAppMessage', 'shareTimeline']\n        })\n\n        //右上角...被动分享好友\n        wx.onShareAppMessage(() => {\n            return {\n                title: 'I`m Shark',\n                imageUrl: \"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep4iaauHk6qmCLM3ASY3ia0CKibSPF3FzFyc3IXR5yZA9uAFXVyGaDTqyX1LB6WpjrB4picu4K7lnXgGw/132\",\n                query: `uid=${0}`,\n            }\n        })\n\n        //右上角...被动分享朋友圈\n        wx.onShareTimeline(() => {\n            return {\n              title: 'I`m Shark',\n              imageUrl: \"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep4iaauHk6qmCLM3ASY3ia0CKibSPF3FzFyc3IXR5yZA9uAFXVyGaDTqyX1LB6WpjrB4picu4K7lnXgGw/132\",\n              query: `uid=${0}`,\n            }\n        })\n\n        wx.onShow(({query}) => {\n            Log.log(\"wx.onShow--->query:\", query)\n            this.setQueryData(query);\n        });\n\n        wx.onHide(() => {\n            Log.log(\"wx.onHide\")\n        });\n\n        // 在首次启动时通过 wx.getLaunchOptionsSync 接口获取\n        const {query}: any = wx.getLaunchOptionsSync()\n        Log.log(\"wx.getLaunchOptionsSync--->query:\", query)\n        this.setQueryData(query);\n    }\n\n    //从获取到query，对游戏内的数据进行处理\n    private setQueryData(query){\n        if(query.uid){\n        }\n    }\n\n    //主动拉取分享好友\n    public shareAppMessage(){\n        this.shareStartTime = Math.floor(new Date().getTime()/1000);\n\n        wx.shareAppMessage({\n            title: \"I`m Shark\",\n            imageUrl: \"https://wx.qlogo.cn/mmopen/vi_32/DYAIOgq83ep4iaauHk6qmCLM3ASY3ia0CKibSPF3FzFyc3IXR5yZA9uAFXVyGaDTqyX1LB6WpjrB4picu4K7lnXgGw/132\",\n            query: `uid=${0}`,\n        })\n    }\n\n    //获取微信步数\n    public getWeRunData(){\n        var self = this;\n        wx.getWeRunData({\n            async success (res) {\n                Log.log(\"getWeRunData\", res);\n                    // 拿 encryptedData 到开发者后台解密开放数据\n                const encryptedData = res.encryptedData\n\n                var params = {\n                    encryptData: encryptedData,\n                    iv: res[\"iv\"],\n                    encryptedData: self.replacenormalcharacter(encryptedData)\n                }\n\n                var stepInfoList = await self.getEncryptedData(params);\n                self.wxRun = stepInfoList[stepInfoList.length - 1][\"step\"];\n            },\n\n            fail(res) {\n                Log.log(\"res===get==fail======\", res);\n                self.wxRun = 0;\n            },\n        })\n        \n    }\n\n    //预览图片功能,下载分享\n    public previewImage(url: string){\n        wx.previewImage({\n            current: url, // 当前显示图片的http链接\n            urls: [url] // 需要预览的图片http链接列表\n        })\n    }\n\n    //跳转小程序\n    public navigateToMiniProgram(appId){\n        wx.navigateToMiniProgram({\n            appId: appId,\n            success(res) {\n              // 打开成功\n              Log.log(\"跳转小程序成功\")\n            }\n        })\n    }\n\n    //播放视频\n    public createVideo(url: string){\n        AudioMng.getInstance().pauseAll();\n        \n        let video = wx.createVideo({\n            x: 0,\n            y: 0,\n            src: url,\n            autoplay: true,\n            initialTime: 0,\n            width: wx.getSystemInfoSync().windowWidth,\n            height: wx.getSystemInfoSync().windowHeight,\n            controls: false,\n            showProgress: false,\n            showProgressInControlMode: false,\n        })\n\n        video.onEnded((res) => {\n            Log.log('=========end', res);\n            EventMng.emit(FrameEventConst.WX_VIDEO_FINISH);\n            AudioMng.getInstance().resumeAll();\n            video.destroy();\n        })\n    }\n\n    //----------------选择照片上传阿里云OSS----------------\n    public chooseImage(){\n        var self = this;\n        wx.chooseImage({\n            count: 1, // 默认最多一次选择9张图\n            sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有\n            sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有\n            success: function (res) {\n               // 返回选定照片的本地文件路径列表，tempFilePath可以作为img标签的src属性显示图片\n               var tempFilePaths = res.tempFilePaths;\n               Log.log(\"tempFilePaths\", tempFilePaths);\n               var nowTime = self.formatTime(new Date());\n    \n               //支持多图上传\n               for (var i = 0; i < res.tempFilePaths.length; i++) {\n                  //显示消息提示框\n                  wx.showLoading({\n                     title: '上传中' + (i + 1) + '/' + res.tempFilePaths.length,\n                     mask: true\n                  })\n    \n                  //上传图片\n                  //你的域名下的/images文件下的/当前年月日文件下的/图片.png\n                  //图片路径可自行修改\n                  self.uploadFile(res.tempFilePaths[i], 'images/' + nowTime + '/',\n                     function (result) {\n                        Log.log(\"======上传成功图片地址为：\", result);\n                        //做你具体的业务逻辑操作\n                        EventMng.emit(FrameEventConst.WX_UPLOAD_IMG_SUCCESS, result);\n                        wx.hideLoading();\n                     }, function (result) {\n                        Log.log(\"======上传失败======\", result);\n                        //做你具体的业务逻辑操作\n    \n                        wx.hideLoading()\n                     }\n                  )\n               }\n            }\n        })\n    }\n\n    private uploadFile(filePath, dir, successc, failc) {\n        if (!filePath || filePath.length < 1) {\n           wx.showModal({\n              title: '图片错误',\n              content: '请重试',\n              showCancel: false,\n           })\n           return;\n        }\n      \n        Log.log('上传图片.....');\n        //图片名字 可以自行定义，     这里是采用当前的时间戳 + 150内的随机数来给图片命名的\n        const aliyunFileKey = dir + new Date().getTime() + Math.floor(Math.random() * 150) + '.png';\n      \n        const aliyunServerURL = this.env.uploadImageUrl;//OSS地址，需要https\n        const accessid = this.env.OSSAccessKeyId;\n        const policyBase64 = this.getPolicyBase64();\n        const signature = this.getSignature(policyBase64);//获取签名\n      \n        wx.uploadFile({\n           url: aliyunServerURL,//开发者服务器 url\n           filePath: filePath,//要上传文件资源的路径\n           name: 'file',//必须填file\n           formData: {\n              'key': aliyunFileKey,\n              'policy': policyBase64,\n              'OSSAccessKeyId': accessid,\n              'signature': signature,\n              'success_action_status': '200',\n           },\n           success: function (res) {\n              if (res.statusCode != 200) {\n                 failc(new Error('上传错误:' + JSON.stringify(res)))\n                 return;\n              }\n              successc(aliyunServerURL + aliyunFileKey);\n           },\n           fail: function (err) {\n              err.wxaddinfo = aliyunServerURL;\n              failc(err);\n           },\n        })\n    }\n\n    private getPolicyBase64() {\n        let date = new Date();\n        date.setHours(date.getHours() + this.env.timeout);\n        let srcT = date.toISOString();\n        const policyText = {\n           \"expiration\": srcT, //设置该Policy的失效时间，超过这个失效时间之后，就没有办法通过这个policy上传文件了 \n           \"conditions\": [\n              [\"content-length-range\", 0, 5 * 1024 * 1024] // 设置上传文件的大小限制,5mb\n           ]\n        };\n      \n        const policyBase64 = base64.encode(JSON.stringify(policyText));\n        return policyBase64;\n    }\n      \n    private getSignature(policyBase64) {\n        const accesskey = this.env.AccessKeySecret;\n        const bytes = Cryptos.HMAC(policyBase64, accesskey, {\n           asBytes: true\n        });\n        const signature = Cryptos.util.bytesToBase64(bytes);\n\n        return signature;\n    }\n\n    private formatTime(date){\n        const year = date.getFullYear()\n        const month = date.getMonth() + 1\n        const day = date.getDate()\n        const hour = date.getHours()\n        const minute = date.getMinutes()\n        const second = date.getSeconds()\n      \n        return [year, month, day].map(this.formatNumber).join('-')\n         // + ' ' + [hour, minute, second].map(formatNumber).join(':')\n    }\n\n    private formatNumber(n) {\n        n = n.toString()\n        return n[1] ? n : '0' + n\n    }\n    //----------------选择照片上传阿里云OSS----------------\n\n    //拿 encryptedData 到开发者后台解密开放数据\n    private getEncryptedData(params): Promise<any> {\n        return new Promise((resolve, reject) => {\n            this.sendHttpMsg(\"login/wxcheck\", params, function(res){\n                let data = res.data;\n                resolve(data.data.res.stepInfoList);\n            }.bind(this))\n        });\n    }\n\n    private replacenormalcharacter(normalcharacterstr: string) {\n        return normalcharacterstr.replace(/\\=/g, \"~\").replace(/\\//g, \"_\").replace(/\\+/g, \"-\")\n    }\n}"]}